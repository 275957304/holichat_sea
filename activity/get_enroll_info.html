<!DOCTYPE html>
<html>
<head>
<title>组别选择</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="format-detection" content="telephone=no"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black"/>
<meta name="distribution" content="global" />
<meta name="author" content="活力圈" />
<meta name="webcrawlers" content="all" />
<link href="../dist/img/ico16.ico" rel="shortcut icon">
<link rel="stylesheet" type="text/css" href="../dist/css/hlq.min.css">
<script type="text/javascript" src="../dist/js/sea.js"></script>
<script type="text/javascript" src="../dist/js/sea_config.js"></script>
</head>
<body>
<header class="header">
    <div class="bnt-back" onclick="history.back()"><i class="icon-back"></i></div>
    <h1>组别选择</h1>
    <a class="bnt_right" href="../index.html"><span class="icon_home"></span></a>
</header>
<footer class="footer">
    <a class="weui_btn weui_btn_warn" id="next" href="javascript:void(0)">下一步</a>
</footer>

<div class="main">
    <div style="opacity:0" class="tab">
        <ul class="tab-nav">
            <li class="current">单人组</li>
            <li>多人组</li>
        </ul>
        <ul class="tab-content">
            <li id="single" class="tab-item"></li>
            <li id="twofold" class="tab-item"></li>
        </ul>
    </div>
	<p id="d"></p>
</div>
<style>
.tab-content .weui_cells{margin-top:-1px;}
</style>
<script type="text/javascript">
var requireFun = ['zepto','base','login','tab','jweixin'];
seajs.use(requireFun, function(zepto,base,login,tab,wx){
    var tab = new tabs.Scroll('.tab', {role:'tab'}),
		id = base.getURLVar('id'),
	    project_id ="",
		group_id="";
    $.ajax({
        type: 'get',
        url: base.activityGetEnrollInfo,
        data: {
            session:base.getItem('session'),
            uid:base.getItem('uid'),
            activity_id:id
        },
        dataType: 'json',
        beforeSend : function(){
            base.tips("加载中...",1);
        },
        success: function(data){
            $('.tips').remove();
			if(data.data.project.length == 0){
				base.tips("没有组别信息");
				setTimeout(function(){window.history.back();},1500)
			};

			var isShuan = false,
				single=[],  //单人组
				twofold=[];	//双人组

			var isShuan = false;
			var isDan = false;
            $.each(data.data.project, function(index,item){
				var s = {}; s.title = item.title; s.group = [];
				var d = {}; d.title = item.title; d.group = [];
				$.each(item.group, function(i,val){
					if(val.single_person == 1){
						isDan = true;
						d.group.push(val);
					}else{
						isShuan = true;
						s.group.push(val);
					}
				});
				if(s.group.length != 0){
					twofold.push(s);
				}
				if(d.group.length != 0){
					single.push(d);
				}
            });

			if(isShuan && isDan){
				$('#single').append(groupList(single,false));
				$('#twofold').append(groupList(twofold,true));
                $('.tab').css('opacity',1);
			}else{
				$('.main').empty();
				$('.main').append(groupList(single,false));
				$('.main').append(groupList(twofold,true));
			}

        },
        error: function(res) {
            base.tips("网络有点卡");
        }
    });


	function groupList(item,mono){
		mono ? st='t' : st='s';
		var _html="";
		$.each(item,function(index,item){
			_html += '<div class="weui_cells_title">'+ item.title +'</div><div class="weui_cells weui_cells_checkbox">';
            var title = item.title;
			$.each(item.group,function(i,val){
                console.log(val);
                //验证是否满员了
				_html += '<label for="'+index + st + i +'" class="weui_cell p10 weui_check_label">';
                //是否预报名
                if(parseInt(val.prepare_enroll)){
                    _html += '<div class="weui_cell_bd weui_cell_primary f14"><span class="predpare">预</span>'  + val.title +'';
                }else{
                    _html += '<div class="weui_cell_bd weui_cell_primary f14">'  + val.title +'';
                }

				if(mono){
					parseInt(val.person_min) == parseInt(val.person_max) ? _html += '<span class="label">'+ val.person_max +'人</span>' : _html += '<span class="label">'+ val.person_min +'~'+ val.person_max +'人</span>';
				}
				if(val.free_type == 'TF'){
					_html += '<p class="dos"><span class="vip">会员:'+ ( val.member_fee == 0 ? '免费' : val.member_fee + '元/组'  ) +'</span>';
					_html += '非会员:'+ ( val.nomember_fee == 0 ? '免费' : val.nomember_fee + '元/组'  ) + '</p>';
				}else{
					_html += '<p class="dos"><span class="vip">会员:'+ ( val.member_fee == 0 ? '免费' : val.member_fee + '元/人'  ) +'</span>';
					_html += '非会员:'+ ( val.nomember_fee == 0 ? '免费' : val.nomember_fee + '元/人'  ) + '</p>';
				}
				_html += '</div><div class="weui_cell_hd">';
				_html += '<input data-desc="'+ item.title +'-'+ val.title +'" data-prepare="' + val.prepare_enroll +'" data-project="' + val.activity_project_id +'"  value="'+ val.id +'" name="radio" type="radio" id="'+ index + st + i +'" class="weui_check"><i class="weui_icon_checked"></i>'
				_html += '</div></label>';
			});
			_html += '</div>';
		});
		return _html;
	}

    $("#next").on('tap',function(){
		project_id = $('input[type="radio"][name="radio"]:checked').data('project');
		group_id = $('input[type="radio"][name="radio"]:checked').val();
        var prepare = $('input[type="radio"][name="radio"]:checked').data('prepare');
        if(project_id == undefined && group_id == undefined){
            base.tips("请选择组别");
            return
        }
        if(prepare == '1' || prepare == '2'){
            var txt = '您选择的' + $('input[type="radio"][name="radio"]:checked').data('desc') + '已开启预报名，需要主办方审核通过后才能成功报名，若审核不通过，将退还报名费用';
            if(!confirm(txt)){
                return
            }
        }
        //赛事报名检测
        $.get(base.activityGetEnrollICheck,{activity_id:id, project_id:project_id, group_id:group_id},function(data){
			console.log(data);
            if(data.ret == 0){
                window.location.href = 'enroll.html?id=' + id + "&project_id=" + project_id + "&group_id=" + group_id;
            }else{
                switch (data.ret) {
                    case 6159: base.tips('报名人数大于赛事最大上限');break;
                }
            }
        },'json');

    });

	//禁止微信
    wx.ready(function(){
        wx.hideOptionMenu();
    });

})
</script>
</body>
</html>
