<!DOCTYPE html>
<html>
<head>
<title>活力圈</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="format-detection" content="telephone=no"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black"/>
<meta name="distribution" content="global" />
<meta name="author" content="活力圈" />
<meta name="webcrawlers" content="all" />
<link href="../dist/img/ico16.ico" rel="shortcut icon">
<link rel="stylesheet" type="text/css" href="../dist/css/hlq.min.css">
<script type="text/javascript" src="../dist/js/sea.js"></script>
<script type="text/javascript" src="../dist/js/sea_config.js"></script>
<style media="screen">
    .login-area{padding: 10px;}
    .login-area .weui_cells{margin-bottom: 1.17647059em; border: 1px solid #ddd; border-radius: 6px;}
    .login-area .weui_label{width:70px;}
</style>
</head>
<body>
<header class="header">
	<h1>用户登录</h1>
</header>
<div class="main">
    <div class="login-area">
        <div class="weui_cells">
            <div class="weui_cell">
                <div class="weui_cell_hd"><label class="weui_label">用户名</label></div>
                <div class="weui_cell_bd weui_cell_primary">
                    <input class="weui_input" type="text" id="phone" placeholder="请输入用户名">
                </div>
            </div>
            <div class="weui_cell">
                <div class="weui_cell_hd"><label class="weui_label">密码</label></div>
                <div class="weui_cell_bd weui_cell_primary">
                    <input class="weui_input" type="password" id="password" placeholder="请输密码">
                </div>
            </div>
        </div>
        <div class="hd">
            <a id="submit" href="javascript:;" class="weui_btn weui_btn_primary">登录</a>
        </div>
    </div>
</div>

<script type="text/javascript">
define(function(require, exports, module){
	require('http://webapi.amap.com/maps?v=1.3&key=faaddee69a0a4d1dca3576d2ae9c2ff6&plugin=AMap.Geocoder');
    //plugin=AMap.Geocoder
});
var requireFun = ['zepto','base','md5','appDown/app-banner'];
seajs.use(requireFun, function(zepto,base,md,app){
    $(function(){
        //base.removeItem('longitude');
        var id = base.getURLVar('id'),
            type = base.getURLVar('type'),
            city_id = base.getItem('city_id'),
            longitude = base.getItem('longitude'), //经度
    		latitude = base.getItem('latitude');  //纬度

            if(!longitude || !city_id){
                //高德获取经纬度
                var map = new AMap.Map("container",{
                    resizeEnable: true
                });
                map.plugin('AMap.Geolocation', function() {
                    geolocation = new AMap.Geolocation({
                        enableHighAccuracy: true,//是否使用高精度定位，默认:true
                        timeout: 10000,          //超过10秒后停止定位，默认：无穷大
                        buttonOffset: new AMap.Pixel(10, 20),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
                        zoomToAccuracy: true,     //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
                        buttonPosition:'RB'
                    });
                    map.addControl(geolocation);
                    geolocation.getCurrentPosition();
                    AMap.event.addListener(geolocation, 'complete', onComplete);//返回定位信息
                    AMap.event.addListener(geolocation, 'error', onError);      //返回定位出错信息
                });
                function onComplete(data){
                    longitude = data.position.getLng();
                    latitude = data.position.getLat();
                    base.setItem("longitude", longitude);
                    base.setItem("latitude", latitude);
                    // var str=['定位成功'];
                    // str.push('经度：' + data.position.getLng());
                    // str.push('纬度：' + data.position.getLat());
                    // str.push('精度：' + data.accuracy + ' 米');
                    // str.push('是否经过偏移：' + (data.isConverted ? '是' : '否'));
                    // console.log(str);
                    regeocoder(longitude,latitude);
                }
                function onError(data) {
                    base.setItem("city_id", '000000');
                    base.setItem("city_name", '全国');
                    console.log('定位失败');
                };

                //高德逆编辑获取城市与城市ID
                function regeocoder(longitude,latitude){
                    var lnglatXY = (longitude + ',' + latitude).split(','); //[116.396574, 39.992706]
                    var geocoder = new AMap.Geocoder({
                        radius: 1000,
                        extensions: "all"
                    });
                    geocoder.getAddress(lnglatXY, function(status, result){
                        if (status === 'complete' && result.info === 'OK') {
                            console.log(result);
                            var city = result.regeocode.addressComponent.adcode.substring(0,4) + '00';
                            base.setItem("city_id", city);
                            base.setItem("city_name", result.regeocode.addressComponent.city);
                            $('.btn_city').text(result.regeocode.addressComponent.city);
                            console.log(city);
                            console.log(result.regeocode.addressComponent.city);
                        }
                    });
                }

            };
            //console.log(base.getItem('city_name'))

        //登录
        $('#submit').on('tap',function(){
            var phone = $('#phone').val();
            var pwd = $.md5($('#password').val());
            $.ajax({
                url: base.login,
                type: 'post',
                dataType: 'json',
                cache: false,
                data: {
                    phone: phone,
                    pwd: $.md5(pwd),
                    device : '',
                    platform: 'weixin',
    				channel:5000
                },
                success: function(data){
    				console.log(data);
                    if(data.ret == 0){
                        base.setItem("session", data.data.session);
        				base.setItem("uid", data.data.uid);
        				base.setItem("device", data.data.device);
        				base.setItem("platform", data.data.platform);

                        if(type){
                            id ? window.location.href = '../'+ type + '/info.html?id=' + id : window.location.href = '../'+ type + '/index.html';
                        }else{
                            location.href = "../index.html"
                        }

                    }else{
                        switch (data.ret) {
            				case 6016: base.tips('该手机号码未注册');break;
            				case 6017: base.tips('密码错误');break;
            				case 6022: base.tips('手机号码错误');break;
            				case 6023: base.tips('手机号码错误');break;
            			}
                    }
                },
                error: function(res){
                    console.log(res);
                }
            });
        });
    });
});
</script>
</body>
</html>
