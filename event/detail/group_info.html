<!DOCTYPE html>
<html>
<head>
<title>活力圈</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="format-detection" content="telephone=no"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black"/>
<meta name="distribution" content="global" />
<meta name="author" content="活力圈" />
<meta name="webcrawlers" content="all" />
<link rel="stylesheet" type="text/css" href="../../dist/css/hlq.min.css">
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript" src="../../dist/js/zepto.min.js"></script>
<script type="text/javascript" src="../../dist/js/base.js"></script>
</head>
<body>
<header class="header">
    <div class="bnt-back" onclick="history.back()"><i class="icon-back"></i></div>
    <h1>参赛者信息</h1>
</header>
<footer class="footer">
    <div class="weui_btn weui_btn_warn" id="signUp">确认报名</div>
</footer>

<div class="main"> 
	<div id="s"></div>
	<div id="tempList">
	
	</div>
</div>
<script type="text/javascript" src="../../dist/js/idcard.js"></script>
<script type="text/javascript" src="../../dist/js/Base64.js"></script>
<script type="text/javascript">
$(function(){
    var event_id = H.getURLVar('event_id'); 
    var project_id = H.getURLVar('event_project_id'); 
    var group_id = H.getURLVar('event_group_id');
	var key = [];
	console.log(project_id);
	console.log(group_id);
    $.ajax({        
        url: H.getEnrollInfoURL,
        type: 'get',
        data: {
            session:H.session, 
            uid:H.uid, 
            event_id:event_id
        },
        dataType: 'json',
		async: false,//改为同步方式
        beforeSend : function(){
            H.tips("加载中...",1);
        },
        success: function(data){
			console.log(data)
            $('.tips').hide();       
            $.each(data.data.project,function(index, item){
				if(project_id == item.id){					
					$.each(item.group,function(i,val){						
						if(group_id == val.id){	
							var template = JSON.parse(val.enroll_template);								
							if(val.single_person == 0){
								var min = val.person_min;
								var max = val.person_max;
								console.log(min);
								console.log(max);
								var _html ="";
								_html += '<div class="weui_cell"><div class="weui_cell_hd"><label class="weui_label">队伍队名称</label></div><div class="weui_cell_bd weui_cell_primary"><input name="team_name" type="text" placeholder="请输入队伍队名称" class="weui_input"></div></div>';
								_html += '<div class="weui_cell weui_cell_select weui_select_after"><div class="weui_cell_hd"><label class="weui_label" for="">队伍人数</label></div><div id="setionBox" class="weui_cell_bd weui_cell_primary">'+ setOpaction(min,max) +'</div></div>';
								setTemplate(min,template);								
								$('body').on('change','#select',function(){
									var item = document.getElementById('select');
									var index = item.selectedIndex;
									var val = item.options[index].value || item.options[0].value;
									setTemplate(val,template);	
								});						
								$('#s').append(_html);
							}else{	
								//单人组						
								var min = 1;								
								setTemplate(min,template);
							}	
						}
					})
				};
            });
         
			
			
        },
        error: function(res) {
            H.tips("网络有点卡");
        }
    });	

	function setOpaction(min,max){
		var min_num = parseInt(min);		
		var max_num = parseInt(max);		
		var i, s="";
		s = '<select class="weui_select" id="select">';
		for(i= min_num; i <= max_num; i++){
			s += '<option value="'+ i +'">'+ i +'</option>';
			console.log(i);
		}
		s += '</select>';
		console.log(max);
		console.log(s)
		return s
	}
	
	function setTemplate(num,item){
		var template="";
		$('#tempList').empty();
		for(var i=1; i <= num; i++){
			template += '<div class="weui_cells_title">参赛者'+ i +'</div><div class="weui_cells weui_cells_form">';
			$.each(item,function(i,val){
				key.push(val.key)
				if(val.key == 'sex'){
					template += '<div class="weui_cell weui_cell_select weui_select_after"><div class="weui_cell_hd"><label class="weui_label" for="">'+ val.name +'</label></div><div class="weui_cell_bd weui_cell_primary"><select name="'+ val.key +'" class="weui_select"><option value="男">男</option><option value="女">女</option></select></div></div>';
						
				}else if(val.key == 'phone'){
					template += '<div class="weui_cell"><div class="weui_cell_hd"><label class="weui_label">'+ val.name +'</label></div><div class="weui_cell_bd weui_cell_primary"><input name="'+ val.key +'" type="number" placeholder="请输入'+ val.name +'" class="weui_input"></div></div>';
				}else{
					template += '<div class="weui_cell"><div class="weui_cell_hd"><label class="weui_label">'+ val.name +'</label></div><div class="weui_cell_bd weui_cell_primary"><input name="'+ val.key +'" type="text" field="'+ val.name +'" placeholder="请输入'+ val.name +'" class="weui_input"></div></div>';
				}
			})
			template += '</div>';
		}
		$('#tempList').append(template);
	};
	
	
	
    
    var team_name = "";
    $('#signUp').on('tap',function(){
        var len = $(".weui_cells_form").length,           
            data = new Array(),
            base64 =""
            truename = "",
            idcard = "",
            phone ="",
            sex = "",
            user_uid = "",
			field1 ="";  
			
		//console.log(key)  ["truename", "field1", "field2"]		
        for(var i=0; i < len; i++){
			var s = {};
			for(var j=0; j < key.length; j++){
				console.log(key[j]);				
				var k = key[j];
				var val = $("input[name='"+ key[j] +"']").eq(i).val();
				var field = $("input[name='"+ key[j] +"']").eq(i).attr('field');
				
				if($("input[name='truename']").length > 0){
					truename = $("input[name='truename']").eq(i).val();
					if(truename == ""){
						H.tips("请填写参赛者"+ (i+1) +"姓名");
						return false;
					}
				};

				if($("input[name='idcard']").length > 0){
					idcard = $("input[name='idcard']").eq(i).val();
					if(idcard == ""){
						H.tips("请填参赛者"+ (i+1) +"身份证");
						return false;
					}else if(!checkCard(idcard)){
						H.tips("参赛者"+ (i+1) +"身份证号码不正确");
						return false;
					}
				};

				if($("input[name='phone']").length > 0){
					phone = $("input[name='phone']").eq(i).val();
					if(phone == ""){
						H.tips("请填参赛者"+ (i+1) +"联系电话");
						return false;
					}else if(!H.isPhone(phone)){
						H.tips("请填参赛者"+ (i+1) +"电话号码不正确");
						return false;
					}
				};
			   
				if($("select[name='sex']").length > 0){
				   sex = $("select").eq(i).val(); 
				};
				
				if(val == ""){
					H.tips("请填参赛者"+ (i+1) +"的" + field);
					return false;
				}
				
				s[k] = val;
				console.log(s);					 
			}				
			data.push(s);
        };
		team_name = $("input[name='team_name']").val();
		if(team_name == ""){
			H.tips("请填队伍名称");
			return false;
		}
        console.log(data);
        //console.log(JSON.stringify(data));
        base64 = BASE64.encoder(JSON.stringify(data));//返回编码后的字符 		
        console.log("编码后" + base64);
        $.ajax({
            type: 'POST',
            url: H.eventEnrollURL, 
            data: {
                event_id : event_id,
                project_id : project_id,
                group_id : group_id,
                session:H.session, 
                team_name : team_name,
                enroll_params: base64
            },
            dataType: 'json',
            beforeSend : function(){
                H.tips("加载中...",1);
            },
            success: function(data){
				console.log(data)
				$('.tips-message').hide();
                if(data.ret == 6161){
                    H.tips("队伍队名己存在");
                    return false; 
                }				
                var event_enroll_id = data.data.event_enroll_id;
				if(data.data.amount == 0){
					window.location.href = 'pay_info.html?event_enroll_id=' + event_enroll_id + "&event_id=" + event_id + "&project_id=" + project_id +'&group_id=' +group_id;
				}else{
					window.location.href = 'pay_confirm.html?event_enroll_id=' + event_enroll_id + "&event_id=" + event_id + "&project_id=" + project_id +'&group_id=' +group_id;
				}
				
            },
            error: function(xhr) {
				console.log(xhr)
              
            }
        });

    });
	
	
	
	//禁用微信分享
	var href = window.location.href;
	var url = href.split('#')[0];
	$.ajax({
		type: 'get',
		url: baseURL + "other/api/wx_js_sign",
		data: {
			appid:'wxcc5c198d146a1779', 
			url:url
		},
		dataType: 'json',
		success: function(data){				
			//通过config接口注入权限验证配置
			wx.config({
				debug     : false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
				appId     : "wxcc5c198d146a1779", // 必填，公众号的唯一标识
				timestamp : data.data.timestamp, // 必填，生成签名的时间戳
				nonceStr  : data.data.noncestr, // 必填，生成签名的随机串
				signature : data.data.signature,// 必填，签名，见附录1
				jsApiList : ["onMenuShareTimeline", "onMenuShareAppMessage", "onMenuShareQQ", "onMenuShareWeibo"] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
			});
			
			wx.ready(function(){		
				wx.hideOptionMenu();
			});
		}
	});
	
});
</script>
</body>
</html>