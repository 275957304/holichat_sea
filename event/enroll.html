<!DOCTYPE html>
<html>
<head>
<title>参赛者信息</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="format-detection" content="telephone=no"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black"/>
<meta name="distribution" content="global" />
<meta name="author" content="活力圈" />
<meta name="webcrawlers" content="all" />
<link href="../dist/img/ico16.ico" rel="shortcut icon">
<link rel="stylesheet" type="text/css" href="../dist/css/hlq.min.css">
<script type="text/javascript" src="../dist/js/sea.js"></script>
<script type="text/javascript" src="../dist/js/sea_config.js"></script>
<script src="http://gosspublic.alicdn.com/aliyun-oss-sdk-4.4.4.min.js"></script>
</head>
<body>
<header class="header">
    <div class="bnt-back" onclick="history.back()"><i class="icon-back"></i></div>
    <h1>参赛者信息</h1>
    <a class="bnt_right" href="../index.html"><span class="icon_home"></span></a>
</header>
<footer class="footer">
    <div class="weui_btn weui_btn_warn" id="signUp">确认报名</div>
</footer>
<div class="main">
	<div id="team"></div>
	<div id="tempList"></div>
</div>
<script type="text/javascript">
var requireFun = ['zepto','base','jweixin','idcard','base64','jsform','md5'];
seajs.use(requireFun, function(zepto,base,wx,idcard,bs64,jsform){
    var id = base.getURLVar('id'),
		project_id = base.getURLVar('project_id'),
		group_id = base.getURLVar('group_id'),
        stsAuthData = null,
        isStsAuth = true,
        promo = false,
        promo_code ="",
        predpare = 0,
        team_name = "",
		isTeam = false;

    $.ajax({
        url: base.stsAuth,
        type: 'get',
        data: {'session':base.getItem("session"),'uid':base.getItem("uid"),'type':'app_image'},
        dataType: 'json',
		async: false,
        success : function(data){
            if(data.ret == '0'){
                stsAuthData = data.data;
            }
        },
        error: function(res) {
            base.tips("获取STS授权失败");
        }
    });

    $.ajax({
        url: base.getEnrollInfo,
        type: 'get',
        data: {
            session:base.getItem("session"),
            uid:base.getItem("uid"),
            event_id:id
        },
        dataType: 'json',
		async: false,
        beforeSend : function(){
            base.tips("加载中...",1);
        },
        success: function(data){
            $('.tips').hide();
            if(data.ret == '0'){
                $.each(data.data.project,function(index, item){
    				if(project_id == item.id){
    					$.each(item.group,function(i,val){
    						if(group_id == val.id){
                                predpare = parseInt(val.prepare_enroll);
    							var temp = JSON.parse(val.enroll_template),
                                    common = temp.common;
                                    template = temp.personal,
                                    common_html = '<form id="commonForm">';

    							if(val.single_person == 0){
    								isTeam = true;
    								var min = parseInt(val.person_min);
    								var max = parseInt(val.person_max);
                                    console.log(temp.common)
                                    common_html += jsform.setTemplateHTML(common,1);
                                    common_html += '</form><div class="weui_cell weui_cell_select weui_select_after"><div class="weui_cell_hd"><label class="weui_label" for="">队伍人数</label></div><div class="weui_cell_bd weui_cell_primary">'+ base.setOpaction(min,max) +'</div></div>';
                                    $('#tempList').empty().append(jsform.setTemplate(min,template,predpare));
    								$('body').on('change','#select',function(){
    									var item = document.getElementById('select');
    									var index = item.selectedIndex;
    									var val = item.options[index].value || item.options[0].value;
                                        $('#tempList').empty().append(jsform.setTemplate(val,template,predpare));
    								});
    								$('#team').append(common_html);
    							}else{
    								var min = 1;
    								$('#tempList').empty().append(jsform.setTemplate(min,template,predpare));
    							}
    						}
    					})
    				};
                })
            }
        },
        error: function(res) {
            base.tips("网络有点卡");
        }
    });

    // 图片上传
    if($('.weui_uploader_input').length > 0){
        var client = new OSS.Wrapper({
            region: 'oss-cn-hangzhou',
            accessKeyId: stsAuthData.AccessKeyId,
            accessKeySecret: stsAuthData.AccessKeySecret,
            bucket: stsAuthData.Bucket,
            stsToken: stsAuthData.SecurityToken,
            timeout: "600000",
        });
        $('.weui_uploader_input').on('change',function(e){
            jsform.toast("图片上传中",true);
            var that = $(this),
                file = e.target.files[0],
                fileName = file.name,
                picType = file.name.substr(file.name.lastIndexOf("."))
                storeAs = 'uploads/',
                netPath = "e" + "/" + id + "/e/" + base.getItem("uid") + "/",
                picName = $.md5(file.name + file.lastModified);
            storeAs = storeAs + netPath + picName + picType;
            client.multipartUpload(storeAs, file).then(function (result){
                var imgUrl = result.name.substr(result.name.indexOf('/')+1);
                that.data('url',imgUrl);
                that.siblings().empty().append('<img src="'+ base.imgHath + result.name +'" >');
                base.tips("上传成功");
                jsform.toastClose();
            }).catch(function (err) {
                console.log(err);
                jsform.toastClose();
            });
        })
    }

    $('#signUp').on('tap',function(){
        var peopleNumber = $(".weui_cells_form"),
            formList = document.getElementById("form1"),
            common_data = {},
            other_fields = [],
            data = [], //所有数据
            merge = {}, //合并数据
            base64 ="", // 编码bs64
            parameter = {}; //参数
        //如果是多人组
        if(isTeam){
            common_data = jsform.commonForm('commonForm');
        }
        //表单提交 peopleNumber:参赛人数 表单ID
        other_fields = jsform.fsubmit(peopleNumber,formList);
        if(!other_fields) return false;

		merge.project_id = parseInt(project_id,10);
		merge.group_id = parseInt(group_id,10);
		merge.common_data = common_data;
		merge.personal_data = other_fields;
		data.push(merge);
		var jsonDate = eval("'" + JSON.stringify(data) + "'");
        base64 = BASE64.encoder(jsonDate);
        console.log("编码后" + base64);
        //参数
        parameter = {
            event_id : id,
            entrance_type: 'a',
            entrance_community_cid : 0,
            session: base.getItem('session'),
            event_enroll_data: base64
        }
        if(promo){
            parameter.coupon_code = promo_code;
        };
        console.log(parameter)
        $.ajax({
            type: 'POST',
            url: base.eventEnroll,
            data: parameter,
            dataType: 'json',
            beforeSend : function(){
                //base.tips("加载中...",1);
            },
            success: function(data){
                console.log(data);
				$('.tips-message').hide();
				if(data.ret == 0){
                    //订单id
                    var enroll_id = data.data[0];
                    //选择赛事支付接口
                    $.ajax({
                        type:'POST',
                        url:base.eventEnrollSelect,
                        data:{
                            event_enroll_id_params : '[' + enroll_id + ']',
                            session : base.getItem('session')
                        },
                        async: false,
                        dataType: 'json',
                        success: function(data){
                            console.log(data);
                            if(data.ret == 0){
                                console.log(data.data.sum_amount);
                                var order = data.data.order_no;
                                if(data.data.sum_amount == 0){
                                    console.log(promo)
                                    //如果是预报名不用到详情页 预报名 0是不用审核，1是先付后审模式，2是先审后付模式。
                                    if(predpare != '0'){
                                        window.location.href = '../mine/index.html';
                                        return
                                    }
            						window.location.href = 'order_info.html?id='+ id +'&enroll_id=' + enroll_id + '&guide=1';
            					}else{
            						window.location.href = '../pay/weixin_unifiedorder.html?id='+ id +'&enroll_id=' + enroll_id + '&type=event' + '&order=' + order + '&predpare=' + predpare;
            					};
                            }
                        },
                        error: function(xhr){
                            console.log(xhr);
                        }
                    });

                }else{
                    switch (data.ret) {
                        case 6161:
                            base.tips("队伍队名己存在");
                            //$("input[name='team_name']").val("").focus();
                            break;
                        case 6193:
                            base.tips("当前优惠码的使用己达上限");
                            promo = false;
                            $("#code").val("");
                            break;
                        case 6388:
                                base.tips("无效的手机号码");
                                break;
                        case 6389:
                                base.tips("无效的身份证号码");
                                break;
                        case 6482:
                                base.tips("无效的港澳通行证号码");
                                break;
                        case 7401:
                                base.tips("报名信息已存在");
                                break;
                        case 6487:
                                base.tips("请填写信息");
                                break;
                        default:
                            //base.tips(data.ret);
                    }
                }
            },
            error: function(xhr) {
				//base.tips(xhr);
            }
        });
    });


    //优惠码
    $.get(base.eventCoupon,{event_id:id},function(data){
        //console.log(data)
        if(data.data.is_coupon == '1'){
            promo = true; //是否有优惠码
            var template = '<div class="weui_cells_title">优惠码</div><div class="weui_cell"><div class="weui_cell_hd"><label class="weui_label">团队优惠码</label></div><div class="weui_cell_bd weui_cell_primary"><input id="code" class="weui_input" type="text" placeholder="请输入优惠码"></div><div id="promoArea" class="weui_cell_ft"></div>';
            $('#tempList').append(template);
        }
    },'json');
    $('#tempList').delegate('#code','blur',function(){
        var code = $(this).val();
        promo_code = code;
        if(code.length > 0 ){
            $.get(base.eventCouponInfo,{code:code,event_id:id},function(data){
                //console.log(data);
                if(data.ret == '0'){
                    if(data.data.remain_qty > 0){
                        $('#promoArea').html('<i class="weui_icon_success"></i>');
                    }else{
                        $("#code").val("");
                        promo = false;
                        base.tips("优惠码过期");
                    }
                }else{
                    $('#promoArea').html('<i class="weui_icon_warn"></i>');
                    base.tips("优惠码不正确");
                }
            },'json');
        }else{
            $('#promoArea').html('');
        }
    });

    //单选框
    $('.radio_sele').on('tap',function(){
        var radioId = $(this).attr('for'),
            checkedState = $("#"+radioId).attr("checked"),
            radioName = $("#"+radioId).attr('name');
        if(checkedState == 'true'){
            $(this).addClass('radio_active')
            $("#"+radioId).attr('checked',false);
        }else{
            $(this).removeClass('radio_active')
            $("#"+radioId).attr('checked',true);
        }
    });


    //禁止微信
    wx.ready(function(){
        wx.hideOptionMenu();
    });

});
</script>
</body>
</html>
