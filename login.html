<!DOCTYPE html>
<html>
<head>
<title>活力圈</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="format-detection" content="telephone=no"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black"/>
<meta name="distribution" content="global" />
<meta name="author" content="活力圈" />
<meta name="webcrawlers" content="all" />
<script src="dist/js/zepto.min.js"></script>
<script src="dist/js/base.js"></script>
<script src="dist/js/Base64.js"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<!--script src="dist/js/wx_port.js"></script-->
</head>
<body>
<div id="data"></div>
<script type="text/javascript">
window.onload = function(){
	if(H.isWeixin){	
		var code = H.getURLVar('code');
		var source = H.getURLVar('source');
		if(code){
			//获取微信接口
			var href = window.location.href;
			var url = href.split('#')[0];
			$.ajax({
				type: 'get',
				url: baseURL + "other/api/wx_js_sign",
				data: {
					appid:'wxcc5c198d146a1779', 
					url:url
				},
				dataType: 'json',
				success: function(data){
					console.log(data);					
					//通过config接口注入权限验证配置
					wx.config({
						debug     : false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
						appId     : "wxcc5c198d146a1779", // 必填，公众号的唯一标识
						timestamp : data.data.timestamp, // 必填，生成签名的时间戳
						nonceStr  : data.data.noncestr, // 必填，生成签名的随机串
						signature : data.data.signature,// 必填，签名，见附录1
						jsApiList : ["openLocation", "getLocation"] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
					});
					
					wx.ready(function(){				

						wx.getLocation({
							type: 'wgs84', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
							success: function (res) {
								var latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
								var longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
								H.setItem("latitude", latitude);
								H.setItem("longitude", longitude);					
							}
						});
						
					});
				},
				error: function(res) {
					H.tips("没有获取到微信接口");
				}
			});			
			
			$.get(baseURL + 'login/sdk/wx_access_token',{'appid':'wxcc5c198d146a1779', "code":code, 'grant_type':'authorization_code'},function(data){
				console.log(data);
				var access_token = data.data.access_token,
					openid = data.data.openid;	
					H.setItem("openid", openid);
				var params = {
					"access_token" : access_token,
					"open_id" : openid,
				}				
				var base64 = BASE64.encoder(JSON.stringify(params));				
				$.ajax({        
					url: baseURL + 'login/sdk/other_login',
					type: 'post',
					data: {
						type: 'weixin', 
						platform : 'web',
						params: base64
					},
					dataType: 'json',
					success: function(data){
						//H.login(data);
						H.setItem("session", data.data.session);
						H.setItem("uid", data.data.uid);
						H.setItem("device", data.data.device);
						H.setItem("platform", data.data.platform);
						if(source == 'user_event'){
							window.location.href = "event/user_event.html";
						}else{
							window.location.href = "event/index.html";
						}						
					},
					error: function(res) {
						alert(res);
					}
				})
			},'json')		
		}

		
	}
}
</script>
</div>
</body>
</html>